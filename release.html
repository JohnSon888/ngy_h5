<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta content="yes" name="apple-mobile-web-app-capable">
<meta content="black" name="apple-mobile-web-app-status-bar-style">
<meta content="telephone=no" name="format-detection">
<meta content="email=no" name="format-detection">
<meta name="viewport" content="initial-scale=1.0, user-scalable=no"> 
<title></title>
<link rel="stylesheet" href="css/main.css" />
<link rel="stylesheet" href="css/demo.css">
<script type="text/javascript" src="js/jquery.min.js" ></script>
<script type="text/javascript" src="js/flexible.js" ></script>
<script type="text/javascript" src="src/lib/jquery/jquery.md5.js"></script>
<script type="text/javascript" src="src/lib/common/common.js"></script>
<script type="text/javascript" src="src/lib/common/farming.js"></script>
<script type="text/javascript" src="src/lib/common/public.js"></script>
<script type="text/javascript" src="src/lib/public/public.js"></script>
<script type="text/javascript" src="http://webapi.amap.com/maps?v=1.3&key=e70d8d1aaa418b8bb2fe504405d220f9&plugin=AMap.Geocoder"></script>
<!-- layer -->
<script type="text/javascript" src="src/lib/layer/layer.js" ></script>
<style type="text/css">
.mach-type{ background: #fff;
    left: 90px;
    position: absolute;
    /*top: 166px;*/
    width: 6.73rem;
    z-index: 900;
display:none}
.mach-type ul{text-align: center;min-height: 100px;max-height: 245px;overflow-y: scroll;}
.mach-type ul li{height: 0.66rem; line-height: 0.66rem; padding: 0.2rem 0;}
</style>
</head>
<body>
	    <section class="body-bj ovw">
	    	<section class="header ovw posin" style="position:fixed;z-index:1000;">农机手发布<a href="javascript:;" class="header-back ovw"><img src="images/back.png"/></a></section>
		     <section class="release-near-content ovw">
		     	<ul class="ld-card-ula rele-work-persoal ovw" style="padding-top: 1.333rem;">
<!--		     		<li class="mers-lia-c mers-lia-d" style="margin-top:0.2rem;">
			    		<aside class="add-plant-as add-plant-ad ovw">
			    			<label class="fl ovw">作业时间：</label>
			    			<input class="add-state start_time" id="start_time" type="date"/>
			    		</aside>
			    	</li>
			    	<li class="mers-lia-c mers-lia-d">
			    		<aside class="add-plant-as add-plant-ad ovw">
			    			<label class="fl ovw">截止时间：</label>
			    			<input class="add-state end_time" id="end_time" type="date"/>
			    		</aside>
			    	</li>-->
			    	<li class="mers-lia-c mers-lia-d machine">
			    		<aside class="add-plant-as add-plant-ad ovw">
			    			<label class="fl ovw">农机类型：</label>
			    			<!-- <select class="add-state mac-type"><option typeid="1">测试一农机类型</option><option typeid="2">测试二农机类型</option></select> -->	
			    			<input class="ld-lia-in mers-lia-a mac-type" type="text" val="" readonly="" />
			    		</aside>
			    	</li>
			<div class="mach-type" style="">
		     	<ul class="mache">
		     		<!-- <li typeid="1">测试1农机类型</li>
		     		<li typeid="2">测试2农机类型</li>
		     		<li typeid="3">测试3农机类型</li>
		     		<li typeid="8">测试4农机类型</li> -->
		     	</ul>
		     </div>
		     		<li class="ld-lia">
			    		<label class="ld-lia-la ovw">农机数量：</label>
			    		<input class="ld-lia-in mers-lia-a njsl" type="number" placeholder="请输入农机数量"/>
			    	</li>
			    	<li class="ld-lia">
			    		<label class="ld-lia-la ovw">报&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;价：</label>
			    		<input class="ld-lia-in mers-lia-a lxbj" type="text" placeholder="请输入报价"/>
			    	</li>
			    	<li class="ld-lia re-work-address">
			    		<label class="ld-lia-la ovw">农机地点：</label>
			    		<input class="ld-lia-in zydd" type="text" placeholder="请输入地点"/>
			    		<img src="images/add_1.png" class="address-s"/>
			    	</li>
			    	<li class="ld-lia">
			    		<label class="ld-lia-la ovw">门牌号码：</label>
			    		<input class="ld-lia-in mers-lia-a xxdz" type="text" placeholder="门牌号码"/>
			    	</li>
                                <li class="ld-lia">
			    		<aside class="add-plant-as add-plant-ad ovw">
			    			<label class="fl ovw">作业范围：</label>
			    			<select class="add-state work-range"><option  value="1">全国</option><option  value="0">周边</option></select>
			    		</aside>
			    	</li>
			    	<li class="ld-lia ld-lie">
			    		<label class="ld-lia-la ovw">详细介绍：</label>
			    		<textarea class="merchants-text ovw xxjs"></textarea>
			    	</li>
		     	</ul>
		     </section>
		     
		    <a class="over-order ovw" href="javascript:;">发布</a>
	    </section>
	<input type="hidden" class="lng" value="">
    <input type="hidden" class="lat" value="">
<script type="text/javascript">
$(function(){
        var machineID = GetQueryParam("machineID");
	var from = GetQueryParam('from');
	var p_c_a = GetQueryParam("address");
	$('.header-back').on('click',function(){
                $.delStorage('pca');
            	$.delStorage('temp_params');
		if(from=="app"){
			window.location.href="mac-list.html";
		}else if(from=="h5"){
			window.location.href="my-work-3.html";
		}else if(from=="details"){
			window.location.href="work-details.html?machineID="+machineID;
		}else{
			backtoNative();
		}
	})
	$('.machine').on('touchend click',function(){
		$('.mach-type').show();
	})
	var province;
	var city;
	var area;
	var town;
	var village; 
	/*****************************默认地点*****************************/
	setTimeout(function(){
             if(!isNull(machineID)&&!isNull(p_c_a)){
        var arr_areaID = current_location_areaIDs.split(",");
        $('.zydd').val(current_location_address);
        province = arr_areaID[0];
		city = arr_areaID[1]==''?0:arr_areaID[1];
		area = arr_areaID[2]==''?0:arr_areaID[2];
		town = arr_areaID[3]==''?0:arr_areaID[3];
		village = arr_areaID[4]==''?0:arr_areaID[4];
                
                }
        },500);
		if(isNull(p_c_a)){
			var get_temp_params =  eval('('+$.getStorage('temp_params')+')');//由JSON字符串转换为JSON对象
//			$('.start_time').val(get_temp_params.starttime);  //作业时间
//			$('.end_time').val(get_temp_params.endtime);  //截止时间
			$('.mac-type').val(get_temp_params.typeNAME);//
			$('.mac-type').attr('val',get_temp_params.typeID);  //农机类型ID
			$('.njsl').val(get_temp_params.count);//农机数量
			$('.lxbj').val(get_temp_params.price);//理想报价
			$('.xxdz').val(get_temp_params.address);//详细地址
			$('.xxjs').val(get_temp_params.intro);//详细介绍
                        $('.zydd').val(get_temp_params.zydd);
			if(p_c_a!="empty"){
				$('.zydd').val(p_c_a);
				geocoder(p_c_a);
			}
			from = get_temp_params.from;
		}
	$('.zydd').on('click',function(){//作业地点
//		var starttime = $('.start_time').val();  //作业时间
//		var endtime = $('.end_time').val();  //截止时间
		var typeNAME = $('.mac-type').val();//
		var typeID = $('.mac-type').attr('val');  //农机类型ID
		var count = $('.njsl').val();//农机数量
		var price = $('.lxbj').val();//理想报价
		var address = $('.xxdz').val();//详细地址
		var intro = $('.xxjs').val();//详细介绍
		var temp_params = {
//			'starttime':starttime,
//			'endtime':endtime,
			'typeNAME':typeNAME,
			'typeID':typeID,
			'count':count,
			'price':price,
			'address':address,
			'intro':intro,
			'from':from,
                        'zydd':$('.zydd').val(),
		};
		$.setStorage('temp_params',temp_params);
                if(isNull(machineID)){
                     window.location.href = "place.html?type=1&detailsID="+machineID;
                }else{
                    window.location.href = "place.html?type=1";
                }
	})
	
	var typeIds=[];
	var typeNames=[];
	// $.each($('.mach-type ul li'),function(i){
	// 	$($('.mach-type ul li')[i]).on('click',function(){alert();
	// 		if($.inArray($(this).attr('typeid'),typeIds)==-1){
	// 			typeIds.push($(this).attr('typeid'));
	// 		}else{
	// 			typeIds.splice($.inArray($(this).attr('typeid'),typeIds),1);
	// 		}
	// 		if($.inArray($(this).text(),typeNames)==-1){
	// 			typeNames.push($(this).text());
	// 		}else{
	// 			typeNames.splice($.inArray($(this).text(),typeNames),1);
	// 		}
	// 		ids = typeIds.join(',');
	// 		names = typeNames.join(',');
	// 		$('.mac-type').attr('val',ids);
	// 		$('.mac-type').val(names);
	// 		$('.mach-type').hide();
	// 	})
	// })
//***********************************获取农机类型*********************
	function machineTypeList(typeID){
        var cmd = 'machineTypeList';//接口命令
        var ts = parseInt(new Date().getTime()/1000);//当前时间戳
        var jsonp = 1;
        var params = {
                
                };
        params = objKeySort(params);//按照属性名升序排列
        var params_str = objChangeStr(params);//拼接params参数的属性值
        params.verify = $.md5(cmd+ts+params_str+'security');//生成验证码           
        $.ajax({
            url : apiURL,//接口地址
            data : {'cmd':cmd, 'ts':ts, 'params':params, 'jsonp':jsonp},
            dataType : 'jsonp',
            success: function(data){ 
                if(isNull(data['body']['list'])){
                    var machineTypeListHtml = '';
                    $.each(data['body']['list'],function(i,val){
                        machineTypeListHtml += '<li typeID="'+val['typeID']+'">'+val['typeName']+'</li>';
                    });
                    $('.mach-type ul').append(machineTypeListHtml);
                }else{
                    html = '<div class="none-more-content">暂无内容</div>';
                    $('.mac-list-sort-type').html(html);
                }
            },
            error: function(XMLHttpRequest, textStatus, errorThrown) {
                layer.msg('网络请求延迟！');
                console.info(XMLHttpRequest.status);
                console.info(XMLHttpRequest.readyState);
                console.info(textStatus);machRelease
            },
        });
    }
    machineTypeList();

	$(document).on('touchend','.mach-type ul li',function(e){
		if($('.mach-type').css('display')=='block'){
			if($.inArray($(this).attr('typeID'),typeIds)==-1){
				typeIds.push($(this).attr('typeid'));
			}else{
				typeIds.splice($.inArray($(this).attr('typeID'),typeIds),1);
			}
			if($.inArray($(this).text(),typeNames)==-1){
				typeNames.push($(this).text());
			}else{
				typeNames.splice($.inArray($(this).text(),typeNames),1);
			}
			ids = typeIds.join(',');
			names = typeNames.join(',');
			$('.mac-type').attr('val',ids);
			$('.mac-type').val(names);
			$('.mach-type').hide();
			e.preventDefault();
		}
		})
	$(".start_time,.end_time,.njsl,.lxbj,.xxdz,.xxjs").on('focus',function(){
		$('.mach-type').hide();
	})
 	function machRelease(params){//发布农机
        var cmd = 'machRelease';//接口命令
        var ts = parseInt(new Date().getTime()/1000);//当前时间戳
        var jsonp = 1;
        params = objKeySort(params);//按照属性名升序排列
        var params_str = objChangeStr(params);//拼接params参数的属性值
        params.verify = $.md5(cmd+ts+params_str+'security');//生成验证码           
        $.ajax({
        	url : apiURL,//接口地址
            data : {'cmd':cmd, 'ts':ts, 'params':params, 'jsonp':jsonp},
            dataType : 'jsonp',
            success: function(data){ 
            	if(data['resultCode']==1){
            		$.delStorage('pca');
            		$.delStorage('temp_params');
            		$('.over-order').attr('disabled','disabled');
                             if(!isNull(machineID)){
	        		layer.msg('农机发布内容已提交');
                             }else{
                                 layer.msg('农机发布内容已保存');
                             }
	        		setTimeout(function(){
	        			if(from=="app"){
							window.location.href="mac-list.html";
						}else if(from=="h5"){
							window.location.href="my-work-3.html";
						}else if(from=="details"){
                                                        window.location.href="work-details.html?machineID="+machineID;
                                                }else{
							backtoNative();
						}
	        		},1000);
	        	}else{
                                sign = 1;
	        		layer.msg(data['resultMessage']);
	        	}
            },
            error: function(XMLHttpRequest, textStatus, errorThrown){
                layer.msg('网络请求延迟！');
                console.info(XMLHttpRequest.status);
                console.info(XMLHttpRequest.readyState);
                console.info(textStatus);
            },
        });
    }

	$('.over-order').click(function(){
		if(sign==1){
//			var starttime = timeStyle($('.start_time').val());  //作业时间
//			var endtime = timeStyle($('.end_time').val());  //截止时间
			var typeID = $('.mac-type').attr('val');  //农机类型ID
			var count = $('.njsl').val();//农机数量
			var price = $('.lxbj').val();//理想报价
			var address = $('.xxdz').val();//详细地址
			var intro = $('.xxjs').val();//详细介绍
			var zydd = $('.zydd').val();
                        var work_range = $('.work-range').val();
			if(isNull(p_c_a)||isNull(machineID)){
				var ssq = eval('('+$.getStorage('pca')+')')?eval('('+$.getStorage('pca')+')'):'';
			}else{
				var ssq = '';
			}
			province = ssq.sf==undefined?province:ssq.sf;
			city = ssq.cs==undefined?city:ssq.cs;
			area = ssq.qx==undefined?area:ssq.qx;
			town = ssq.xz==undefined?town:ssq.xz;
			village = ssq.cz==undefined?village:ssq.cz;
//			if(!isNull(starttime)){
//				layer.msg('请填写作业时间');
//				return false;
//			}
//			if(!isNull(endtime)){
//				layer.msg('请填写截止时间');
//				return false;
//			}
//			if(starttime>endtime){
//				layer.msg('填写时间不对');
//				return false;
//			}
			if(!isNull(typeID)){
				layer.msg('请填农机类型');
				return false;
			}
			if(!isNull(count)){
				layer.msg('请填写农机数量');
				return false;
			}
			if(!isNull(price)){
				layer.msg('请填写报价');
				return false;
			}
			if(!isNull(zydd)){
				layer.msg('请填写农机地点');
				return false;
			}
			if(!isNull(address)){
				layer.msg('请填写门牌号码');
				return false;
			}
			if(!isNull(intro)){
				layer.msg('请填写详细介绍');
				return false;
			}
//			if(starttime>endtime){
//				layer.msg('填写时间不对，作业时间大于截止时间');
//		    	return false;
//			}
                        sign = 0;
                        if(isNull(machineID)){
                            var machRelease_params = {
                                        'machineID':machineID,
					'userid' : userid,
//                                        'starttime' : starttime,
//                                        'endtime' : endtime,
                                        'typeID' : typeID,
                                        'count' : count,
                                        'price' : price,
                                        'province' : province,
                                        'city' : city,
                                        'area':area,
                                        'town':town,
                                        'village':village,
                                        'address':address,
                                        'intro':intro,        
                                                        'lng':$('.lng').val(),//'118.834861',
                                                        'lat':$('.lat').val(),//'32.017352',
                                                        'allArea':work_range,
                            }
                        }else{
                            var machRelease_params = {
                                            'userid' : userid,
//                            'starttime' : starttime,
//                            'endtime' : endtime,
                            'typeID' : typeID,
                            'count' : count,
                            'price' : price,
                            'province' : province,
                            'city' : city,
                            'area':area,
                            'town':town,
                            'village':village,
                            'address':address,
                            'intro':intro,        
                                            'lng':$('.lng').val(),//'118.834861',
                                            'lat':$('.lat').val(),//'32.017352',
                                            'allArea':work_range,
                            }
                        }
//			 console.info(machRelease_params);
			machRelease(machRelease_params);
		}
	}); 

        function machDetail(params){
            var cmd = 'machDetail';//农机手详情接口命令
	    var ts = parseInt(new Date().getTime()/1000);//当前时间戳
	    var jsonp = 1;
	    params = objKeySort(params);//按照属性名升序排列
	    var params_str = objChangeStr(params);//拼接params参数的属性值
	    params.verify = $.md5(cmd+ts+params_str+'security');//生成验证码           
	    $.ajax({
	        url : apiURL,//接口地址
	         data : {'cmd':cmd, 'ts':ts, 'params':params, 'jsonp':jsonp},
	        dataType : 'jsonp',
	        success: function(data){console.info(data);
	            if(isNull(data['body'])){
                        if(!isNull(p_c_a)){
                            var address_content = data['body']['area']['province']['areaName']+data['body']['area']['city']['areaName']+data['body']['area']['area']['areaName']+data['body']['area']['town']['areaName']+data['body']['area']['village']['areaName'];
//                            $('.start_time').val(data['body']['starttime']);
//                            $('.end_time').val(data['body']['starttime']);
                            $('.mac-type').val(data['body']['typeName']);
                            $('.mac-type').attr('val',data['body']['typeID']);
                            typeIds.push(data['body']['typeID']);
                            typeNames.push(data['body']['typeName']);
                            $('.njsl').val(data['body']['count']);//农机数量
                            $('.lxbj').val(data['body']['price']);//理想报价
                            $('.zydd').val(address_content);
                            $('.xxdz').val(data['body']['detailAddress']);//详细地址
                            $('.xxjs').val(data['body']['intro']);//详细介绍
                            $('.work-range').val(data['body']['allArea']);
                            var pca = {
                                    'sf':data['body']['area']['province']['areaID'],
                                    'cs':data['body']['area']['city']['areaID'],
                                    'qx':data['body']['area']['area']['areaID'],
                                    'xz':data['body']['area']['town']['areaID'],
                                    'cz':data['body']['area']['village']['areaID'],
                                }
                            $.setStorage('pca',pca);
                        }
                    }
	        },
	        error: function(XMLHttpRequest, textStatus, errorThrown) {
	            layer.msg('网络请求延迟！');
	            console.info(XMLHttpRequest.status);
	            console.info(XMLHttpRequest.readyState);
	            console.info(textStatus);
	        },
	    });
	}
        if(isNull(machineID)){
            $('.over-order').html("保存");
            var machDetail_params = {
                    'userid':userid,
                    'machineID':machineID,//machineID
            };
            machDetail(machDetail_params);
        }
})
</script>
</body>
</html>
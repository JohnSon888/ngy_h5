<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta content="yes" name="apple-mobile-web-app-capable">
    <meta content="black" name="apple-mobile-web-app-status-bar-style">
    <meta content="telephone=no" name="format-detection">
    <meta content="email=no" name="format-detection">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title></title>
    <link rel="stylesheet" href="css/main.css" />
    <link rel="stylesheet" href="css/demo.css">
    <script type="text/javascript" src="js/jquery.min.js" ></script>
    <script type="text/javascript" src="js/flexible.js" ></script>
    <script type="text/javascript" src="src/lib/jquery/jquery.md5.js"></script>
    <script type="text/javascript" src="src/lib/common/common.js"></script>
    <script type="text/javascript" src="src/lib/common/farming.js"></script>
    <script type="text/javascript" src="src/lib/common/public.js"></script>
    <script type="text/javascript" src="src/lib/public/public.js"></script>
    <!-- layer -->
    <script type="text/javascript" src="src/lib/layer/layer.js"></script>
    <style type="text/css">
    .personal-ula li:first-child {
            line-height: 1.173rem;
    height: 1.173rem;
    }
    .personal-ula .none-right-arrow{
        background: none;
    }
    .personal-ula .none-right-arrow .personal-some {
        padding-right: 0.44rem;
}
.help-center {
    background: #fff;
    width: 96%;
    padding-left: 0.37rem;
}
.personal-ula li .help-name {
     text-indent: 0rem; 
}
.release-intro{
    height: 6.66rem;
    margin-left: 0.37rem;
    margin-top: 0.37rem;
    border-bottom: 1px solid #ececec;
}
.release-intro .merchants-text {
    display: block;
    width: 100%;
    height: 68%;
    position: relative;
    left: 0;
    bottom: 0;
    z-index: 22;
}
.none-right-arrow input{
    height: 1.173rem;
}
.plant-imgb{
    margin-left: 0;
}
#datepicker{height:100%;}
div#jedatebox{
    top:20%;
    left:5%;
    width:90%;
    font-size: 22px;
}
.release-dialog {
        display: none;
        position: absolute;
        right: 0;
        top: 0;
        bottom: 0;
        width: 280px;
        height: 90px;
        z-index: 1000;
        left: 50%;
        margin-left: -140px;
    }

    .release-dialog .content {
        position: relative;
        margin-top: 170px;
    }

    .release-dialog .release-content {
        width: 280px;
        height: 90px;
        display: flex;
        justify-content: flex-start;
        align-items: center;
        border: 1px solid #ccc;
        border-radius: 6px;
        margin: 0 auto;
        margin-bottom: 0.5rem;
        background: #fff;
    }

    .release-dialog .release-content .release-img {
        width: 68px;
        height: 55px;
        margin-left: 0.5rem;
        margin-right: 0.5rem;
    }

    .release-dialog .release-content .release-img img {
        width: 100%;
        height: 100%;
    }

    .release-dialog .release-content p {
        font-size: 13px;
        color: #000;
    }

    .release-dialog .release-content .release-title {
        font-size: 20px;
    }

    .release-dialog .release-content .release-subTitle {
        color: #888;
    }
.mask {
        position: absolute;
        left: 0;
        right: 0;
        top: 0;
        bottom: 0;
        z-index: 999;
        background: #000;
        opacity: 0.4;
        display: none;
    }
</style>
</head>

<body>
    <section class="body-bj">
        <section class="header ovw posin">零工零活发布<a href="javascript:;" class="header-back ovw"></a></section>
        <section class="add-subs ovw">
            <div class="release-intro">
                <textarea id="detail" class="merchants-text ovw description" placeholder="请输入发布内容..."></textarea>
                <p>
                    <span class="fl plant-imgb ovw old_pic old-pic-add"><img src="images/plant_2.png"></span>
                </p>
            </div>
            <ul class="help-center personal-ula ovw btzl">
                <li class="none-right-arrow">
                    <label class="help-name ovw">联系人</label><input id="concat" class="personal-some ovw" placeholder="请输入联系人姓名"></input></li>
                <li class="none-right-arrow">
                    <label class="help-name ovw">电话</label><input id="phone" class="personal-some ovw" placeholder="请输入电话号码"></input></li>
                <li class="none-right-arrow address-arrow">
                    <label class="help-name ovw address-label">地点</label>
                    <samp class="personal-some ovw address-value">请选择地点</samp>
                </li>
                <!-- <li>
                    <label class="help-name ovw">出发时间</label><input id="datepicker" class="personal-some" placeholder="请选择"></li> -->
                <li class="none-right-arrow">
                    <input id="address" class="help-name ovw" placeholder="请输入具体位置"></input>
                </li>
            </ul>
            <a id="fabu" class="over-order ovw topic_tj" href="javascript:;">发布</a>
        </section>
    </section>
    <div class="mask"></div>
    <div class="release-dialog">
        <div class="content">
            <div class="release-content">
                <div class="release-img">
                    <img src="images/img1.png">
                </div>
                <div class="release-now">
                    <p class="release-title">立即发布</p>
                    <p class="release-subTitle">我已填写完成，立即发布</p>
                </div>
            </div>
            <div class="release-content">
                <div class="release-img">
                    <img src="images/img2.png">
                </div>
                <div class="complete-info">
                    <p class="release-title">完善信息</p>
                    <p class="release-subTitle">我还有内容需要添加，继续填写</p>
                </div>
            </div>
        </div>
    </div>
    <!-- 地址选择框 -->
    <section class="layer-bj layer-map-bj"></section>
    <div class="layer-area layer-up-some ovw" style="display:none;height:172px;bottom:0rem;z-index: 888;">
            <ul class="mac-all-country" style="width:92%;margin:10px auto;line-height:39px;">
                <li style="width:31%;height:39px;float:left;border: 1px solid #ddd;margin-right:2.3%;"><select style="width:100%;z-index:100;" class="sf"><option areaID="-1">省份</option></select></li>
                <li style="width:31%;height:39px;float:left;border: 1px solid #ddd;margin-right:2.3%;"><select style="width:100%;z-index:100;" class="cs"><option areaID="0">城市</option></select></li>
                <li style="width:31%;height:39px;float:left;border: 1px solid #ddd;"><select style="width:100%;z-index:100;" class="qx"><option areaID="0">区县</option></select></li>
                <li style="width:48%;height:39px;float:left;border: 1px solid #ddd;margin-right:2.3%;margin-top:8px;"><select style="width:100%;z-index:100;" class="xz"><option areaID="0">乡镇</option></select></li>
                <li style="width:48%;height:39px;float:left;border: 1px solid #ddd;margin-top:8px;"><select style="width:100%;z-index:100;" class="cz"><option areaID="0">村</option></select></li>
                <li style="width:100%;height:36px;float:left;margin-top:25px;line-height:36px;background:#dd1616;font-size:14px;color:white;border-radius:3px;text-align:center;" class="area-sure">确定</li>
            </ul>
        </div>
    <script type="text/javascript">
    // function GetQueryString(name)
    // {
    //      var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
    //      var r = window.location.search.substr(1).match(reg);
    //      if(r!=null)return  unescape(r[2]); return null;
    // };
    // var userid = GetQueryString(userid)
    // var pulishID = GetQueryString(pulishID)
    userid = 1;
    get_userInfo(userid);
    //获得用户信息
    function get_userInfo(userid){
        if (!userid) {
            layer.msg('请重新登录！');return
        }
        var cmd = 'userInfo';//接口命令
        var ts = parseInt(new Date().getTime()/1000);//当前时间戳
        var jsonp = 1;
        var params = {
                'userid' : userid,
                };
        params = objKeySort(params);//按照属性名升序排列
        var params_str = objChangeStr(params);//拼接params参数的属性值
        params.verify = $.md5(cmd+ts+params_str+'security');//生成验证码           
        $.ajax({
            url : 'http://ngy.innke.net/api/index.php',//接口地址
            data : {'cmd':cmd, 'ts':ts, 'params':params, 'jsonp':jsonp},
            dataType : 'jsonp',
            success: function(data){
               $('#concat').val(data.body.truename);
               $('#phone').val(data.body.phone);

               $('.personal-some').text(data.body.location.area.areaName+data.body.location.city.areaName+data.body.location.province.areaName+data.body.location.town.areaName+data.body.location.village.areaName);
               console.log(data);
            },
            error: function(XMLHttpRequest, textStatus, errorThrown) {
                layer.msg('网络请求延迟！');
                console.info(XMLHttpRequest.status);
                console.info(XMLHttpRequest.readyState);
                console.info(textStatus);
            },
        });
    }
    var apiURL = 'http://ngy.innke.net/apiv2/index.php'
        $('#fabu').click(function(){
            //弹框选择
            $('.mask').show();
            $('.release-dialog').show();
        })
        // $('#datepicker').click(function(){
        //     var datepickerOptions = {
        //           dateCell:"#datepicker", 
        //           format:"YYYY-MM-DD hh:mm:ss", //日期格式
        //           minDate:"1900-01-01 00:00:00", //最小日期
        //           maxDate:"2099-12-31 23:59:59", //最大日期
        //           isinitVal:false, //是否初始化时间
        //           isTime:true, //是否开启时间选择
        //           isClear:true, //是否显示清空
        //           festival:false, //是否显示节日
        //           zIndex:999,  //弹出层的层级高度
        //           marks:null, //给日期做标注
        //           choosefun:function(val) {},  //选中日期后的回调
        //           clearfun:function(val) {},   //清除日期后的回调
        //           okfun:function(val) {}       //点击确定后的回调
        //     };
        //     jeDate(datepickerOptions);
        // })
        $('.mask').click(function() {
            $(this).hide();
            $('.release-dialog').hide();
        });
        // 立即发布
        $('.release-now').click(function() {
            mech_publishInfo('back');
        });
        // 完善信息
        $('.complete-info').click(function() {
            mech_publishInfo('go');            
        });
        var addrDic = {};
        function mech_publishInfo(opt){
            var cmd  = 'publishInfo';
            var ts = parseInt(new Date().getTime() / 1000); 
            var jsonp = 1;
            
            var name = $('#concat').val();
            var phone = $('#phone').val();
            var detail = $('#detail').val();
            var address = $('#address').val();
            var province = addrDic.province;
            var city = addrDic.city;
            var area = addrDic.area;
            var town = addrDic.town;
            var village = addrDic.village;
            var images = '1'

            //出发时间接口没有
            // var time = $('#datepicker').val();
            var params = {
                userid:userid,
                type:1,
                detail:detail,
                verify:'',
                images:images,
                name:name,
                phone:phone,
                province:province,
                city:city,
                area:area,
                town:town,
                village:village,
                address:address,
            }
            params = objKeySort(params);//按照属性名升序排列
            var params_str = objChangeStr(params);//拼接params参数的属性值
            params.verify = $.md5(cmd+ts+params_str+'security');//生成验证码
            console.log(params);
             $.ajax({
                    url : apiURL,//接口地址
                data : {'cmd':cmd, 'ts':ts, 'params':params, 'jsonp':jsonp,type:'2'},
                dataType : 'jsonp',
                success: function(data){
                    console.log(data);
                    if(data.resultCode=='-1'){
                        layer.msg(data.resultMessage);
                    }else{
                        if (opt=='go') {
                            setTimeout(function(){
                                location.href = 'seconds-hand-complete.html?userid='+userid+'&pulishID='+data.body.publishID;
                            },500);     
                        }else{
                            backtoPrev(1);
                        }
                        
                        layer.msg('发布成功');
                    }
                },
                error: function(XMLHttpRequest, textStatus, errorThrown){
                    layer.msg('网络请求延迟！');
                    console.info(XMLHttpRequest.status);
                    console.info(XMLHttpRequest.readyState);
                    console.info(textStatus);
                },
            });
        }

        // 地址选择
        $('.address-value').click(function() {
            $('.layer-area').toggle();
            if ($('.layer-area').css('display') == 'block') {
                $('.layer-map-bj').show();
            } else {
                $('.layer-map-bj').hide();
            }
            // 计算地址弹框的高度
            var height = $('body').height() - $('.layer-up-some').height();
            $('.layer-up-some').css('top',height);
            getArea(0,1,1);
        });
        $('.layer-map-bj').click(function() {
            $(this).hide();
            $('.layer-area').hide();
        })
        /****************************获取地区信息接口********************
             **type:1.省份；2.城市，3.区县；4.乡镇
             */
            function getArea(areaID, type, when) {
                var cmd = 'getArea';//农机投诉接口命令
                var ts = parseInt(new Date().getTime() / 1000);//当前时间戳
                var jsonp = 1;
                var params = {
                    'areaID': areaID,
                };
                params = objKeySort(params);//按照属性名升序排列
                var params_str = objChangeStr(params);//拼接params参数的属性值
                params.verify = $.md5(cmd + ts + params_str + 'security');//生成验证码           
                $.ajax({
                    url: apiURL, //接口地址
                    data: {'cmd': cmd, 'ts': ts, 'params': params, 'jsonp': jsonp},
                    dataType: 'jsonp',
                    success: function (data) {
                        if (isNull(data['body']['list'])) {
                            var areaHtml = '';
                            $.each(data['body']['list'], function (i, val) {
                                areaHtml += '<option areaID="' + val['areaID'] + '" value="' + val['areaID'] + '">' + val['areaName'] + '</option>';
                            });
                            switch (parseInt(type)) {
                                case 1:
                                    $('.sf').append(areaHtml);
                                    break;
                                case 2:
                                    $('.cs').append(areaHtml);
                                    break;
                                case 3:
                                    $('.qx').append(areaHtml);
                                    break;
                                case 4:
                                    $('.xz').append(areaHtml);
                                    break;
                                case 5:
                                    $('.cz').append(areaHtml);
                                    break;
                            }
                            if (when == 0) {        //0  当前位置
                                if (current_location_address != '') {   //获取到当前位置
                                    var arr_areaID = current_location_areaIDs.split(",");
                                    var arr_areaNames = current_location_areaNames.split(",");
                                } else {                      //没获取到当前位置使用用户设置的位置
                                    var arr_areaID = location_areaIDs.split(",");
                                    var arr_areaNames = location_areaNames.split(",");
                                }
                                $('.sf').val(arr_areaID[0]);
                                $('.cs').val(arr_areaID[1]);
                                $('.qx').val(arr_areaID[2]);
                                $('.xz').val(arr_areaID[3]);
                                $('.cz').val(arr_areaID[4]);
                            } else if (when == 1) {  //  首页设置位置
                                var arr_areaID = location_areaIDs.split(",");
                                var arr_areaNames = location_areaNames.split(",");
                                $('.sf').val(arr_areaID[0]);
                                $('.cs').val(arr_areaID[1]);
                                $('.qx').val(arr_areaID[2]);
                                $('.xz').val(arr_areaID[3]);
                                $('.cz').val(arr_areaID[4]);
                            }
                        } else {
                            // layer.msg('暂无区域内容');
                        }
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        layer.msg('网络请求延迟！');
                        console.info(XMLHttpRequest.status);
                        console.info(XMLHttpRequest.readyState);
                        console.info(textStatus);
                    },
                });
            }
            $('.sf').on('change', function () {
                if ($('.sf option:selected').attr('areaID') != -1) {
                    $('.cs').html('');
                    $('.cs').append('<option areaID="0">请选择城市</option>');
                    $('.qx').html('');
                    $('.qx').append('<option areaID="0">请选择区县</option>');
                    $('.xz').html('');
                    $('.xz').append('<option areaID="0">请选择乡镇</option>');
                    $('.cz').html('');
                    $('.cz').append('<option areaID="0">请选择村庄</option>');
                    if ($('.sf option:selected').attr('areaID') != 0) {
                        getArea($('.sf option:selected').attr('areaID'), 2);
                    }
                } else {
                    $('.cs').html('<option areaID="0">请选择城市</option>');
                    $('.qx').html('<option areaID="0">请选择区县</option>');
                    $('.xz').html('<option areaID="0">请选择乡镇</option>');
                    $('.cz').html('<option areaID="0">请选择村庄</option>');
                }
            })
            $('.cs').on('change', function () {
                if ($('.cs option:selected').attr('areaID') != 0) {
                    $('.qx').html('');
                    $('.qx').append('<option areaID="0">请选择区县</option>');
                    $('.xz').html('');
                    $('.xz').append('<option areaID="0">请选择乡镇</option>');
                    $('.cz').html('');
                    $('.cz').append('<option areaID="0">请选择村庄</option>');
                    getArea($('.cs option:selected').attr('areaID'), 3);
                } else {
                    $('.qx').html('<option areaID="0">请选择区县</option>');
                    $('.xz').html('<option areaID="0">请选择乡镇</option>');
                    $('.cz').html('<option areaID="0">请选择村庄</option>');
                }
            })
            $('.qx').on('change', function () {
                if ($('.qx option:selected').attr('areaID') != 0) {
                    $('.xz').html('');
                    $('.xz').append('<option areaID="0">请选择乡镇</option>');
                    $('.cz').html('');
                    $('.cz').append('<option areaID="0">请选择村庄</option>');
                    getArea($('.qx option:selected').attr('areaID'), 4);
                } else {
                    $('.xz').html('<option areaID="0">请选择乡镇</option>');
                    $('.cz').html('<option areaID="0">请选择村庄</option>');
                }
            })
            $('.xz').on('change', function () {
                if ($('.xz option:selected').attr('areaID') != 0) {
                    $('.cz').html('');
                    $('.cz').append('<option areaID="0">请选择村庄</option>');
                    getArea($('.xz option:selected').attr('areaID'), 5);
                } else {
                    $('.cz').html('<option areaID="0">请选择村庄</option>');
                }
            })
            $(document).on('touchend', '.area-sure', function () {
                // 获取省市区地址和value
                var sfText = $('.sf option:selected').text();
                var sfValue = $('.sf option:selected').val();
                var csText = $('.cs option:selected').text();
                var csValue = $('.cs option:selected').val();
                var qxText = $('.qx option:selected').text();
                var qxValue = $('.qx option:selected').val();
                var xzText = $('.xz option:selected').text();
                var xzValue = $('.xz option:selected').val();
                var czText = $('.cz option:selected').text();
                var czValue = $('.cz option:selected').val();

                var addr = sfText+csText+qxText+xzText+czText;
                $('.address-value').text(addr);
                addrDic.province = sfValue;
                addrDic.city = csValue;
                addrDic.area = qxValue;
                addrDic.town = xzValue;
                addrDic.village = czValue;
                addrDic.addr = addr;
                $('.layer-map-bj').hide();
                $('.layer-area').hide();

                console.log(addrDic);
                
                
            })
    </script>
</body>

</html>
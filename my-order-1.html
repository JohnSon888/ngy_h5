<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta content="yes" name="apple-mobile-web-app-capable">
<meta content="black" name="apple-mobile-web-app-status-bar-style">
<meta content="telephone=no" name="format-detection">
<meta content="email=no" name="format-detection">
<title></title>
<link rel="stylesheet" href="css/main.css" />
<link rel="stylesheet" href="css/demo.css">
<script type="text/javascript" src="js/jquery.min.js" ></script>
<script type="text/javascript" src="js/flexible.js" ></script>
<script type="text/javascript" src="src/lib/jquery/jquery.md5.js"></script>
<script type="text/javascript" src="src/lib/common/common.js"></script>
<!-- layer -->
<script type="text/javascript" src="src/lib/layer/layer.js" ></script>
<script type="text/javascript" src="src/lib/common/farming.js"></script>
<script src="src/lib/public/public.js" type="text/javascript"></script>
<style type="text/css">
	.none-more-content{
        color: #868686;
        font-size: 14px;
        height: 200px;
        line-height: 200px;
        text-align: center;
    }
</style>
<script>
	$(function(){
		$('.import-a').on('focus',function(){
			$(this).parent().next().css('background','#dd1616')
		})
		$('.import-a').on('blur',function(){
			$(this).parent().next().css('background','#bbb')
		})
	})
</script>
</head>
<body>
	<section class="body-bj ovw">
	    <section class="header ovw posin">农活详情<a href="#" class="header-back ovw"><img src="images/back.png"/></a><a href="javascript:void(0);" class="header-reg farm-work-mark">关注</a></section>
	<!--     <cite class="my-order-sate my-order-icona ovw">待接单</cite>
	    <article class="my-order-content-a ovw">
	    	<dl class="my-order-content-dla ovw">
	    		<dt>
	    			<img src="images/ing_1.png" class="order-tx" />
	    			<div class="fl">
	    				<p class="my-order-name ovw"><font class="fl ovw">sunnyue</font><img src="images/ing_2.png" class="fl"/></p>
	    			    <span class="my-order-name ovw">180****7889</span>
	    			</div>
	    		</dt>
	    		<dd><a href=""><img src="images/ing_3.png"/></a></dd>
	    	</dl>
	    	<ul class="my-order-dete ovw">
	    		<li><label class="my-order-dete-time ovw fl">认证信息:</label><span class="fl ovw">
	    			<img src="images/cer-icon-2.png" class="cer-icon-a" />
	    			<img src="images/cer-icon-3.png" class="cer-icon-b" />
	    			<img src="images/cer-icon-4.png" class="cer-icon-c" />
	    			<img src="images/cer-icon-5.png" class="cer-icon-d" />
	    			<img src="images/cer-icon-1.png" class="cer-icon-e" />
	    			<img src="images/cer-icon-7.png" class="cer-icon-f" />
	    			<img src="images/cer-icon-6.png" class="cer-icon-g" />
	    		</span></li>
	    		<li><label class="my-order-dete-time ovw fl">作业时间:</label><p class="my-order-dete-pb ovw fl">2016-12-30</p></li>
	    		<li><label class="my-order-dete-time ovw fl">作业地点:</label><p class="my-order-dete-pb my-order-dete-pc ovw fl">上海市闵行区 泰虹路268号万科时一区</p></li>
	    		<li><label class="my-order-dete-time ovw fl">作业面积:</label><p class="my-order-dete-pb ovw fl">200亩</p></li>
	    		<li><label class="my-order-dete-time ovw fl">作业内容:</label><p class="my-order-dete-pb ovw fl">收割</p></li>
	    		<li><label class="my-order-dete-time ovw fl">理想报价:</label><p class="my-order-dete-pb ovw fl">¥2000/亩</p></li>
	    		<li><label class="my-order-dete-time ovw fl">详细说明:</label><p class="my-order-dete-pb ovw fl">小麦、玉米</p></li>
	    	</ul>
	    </article> -->
	    <!-- <a class="over-order ovw" href="">我要接单</a> -->
	    <section class="my-dis-cont ovw">
	    	<!-- <dl class="my-order-discuss ovw">
		    	<dt><img src="images/ing_1.png"/></dt>
		    	<dd>
		    		<span class="my-or-spa ovw">sunnyue</span>
		    		<p class="my-or-pa ovw">张艺兴这个小孩子还是不错滴，台下呆萌，台上霸气，爆发极品反差魅力 ...</p>
		    		<samp class="my-or-sap ovw">2016-12-23 10:10:10</samp>
		    	</dd>
		    </dl>
		    <dl class="my-order-discuss ovw">
		    	<dt><img src="images/ing_1.png"/></dt>
		    	<dd>
		    		<span class="my-or-spa ovw">sunnyue</span>
		    		<p class="my-or-pa ovw">张艺兴这个小孩子还是不错滴，台下呆萌，台上霸气，爆发极品反差魅力 ...</p>
		    		<samp class="my-or-sap ovw">2016-12-23 10:10:10</samp>
		    	</dd>
		    </dl> -->
	    </section>
	    <section class="my-import ovw">
	    	<ul class="my-import-ula ovw">
	    		<li><input placeholder="输入评论内容..." class="import-a"/></li>
	    		<li style="background: #dd1616 none repeat scroll 0 0;" class="aa">提交</li>
	    	</ul>
	    </section>
	</section>
<script type="text/javascript">
$(function(){
	var farmWorkID = GetQueryParam("farmWorkID");
	//*********************************农活详情***********************************
	function farmWorkDetail(params){
		var cmd = 'farmWorkDetail';//农活详情接口命令
	    var ts = parseInt(new Date().getTime()/1000);//当前时间戳
	    var jsonp = 1;
	    params = objKeySort(params);//按照属性名升序排列
	    var params_str = objChangeStr(params);//拼接params参数的属性值
	    params.verify = $.md5(cmd+ts+params_str+'security');//生成验证码           
	    $.ajax({
	        url : apiURL,//接口地址
	         data : {'cmd':cmd, 'ts':ts, 'params':params, 'jsonp':jsonp},
	        dataType : 'jsonp',
	        success: function(data){
	            if(isNull(data['body'])){console.info(data);
	            	//是否认证，背景图片
	            	if(data['body']['authentication']['phone']==1){
	            		var phone_img = "images/cer-icon-2.png";
	            	}else{
	            		var phone_img = "images/cer_1.png";
	            	}
	            	if(data['body']['authentication']['realname']==1){
	            		var realname_img = "images/cer-icon-3.png";
	            	}else{
	            		var realname_img = "images/cer_2.png";
	            	}
	            	if(data['body']['authentication']['land']==1){
	            		var land_img = "images/cer-icon-4.png";
	            	}else{
	            		var land_img = "images/cer_3.png";
	            	}
	            	if(data['body']['authentication']['contractor']==1){
	            		var contractor_img = "images/cer-icon-5.png";
	            	}else{
	            		var contractor_img = "images/cer_4.png";
	            	}
	            	if(data['body']['authentication']['machine']==1){
	            		var machine_img = "images/cer-icon-6.png";
	            	}else{
	            		var machine_img = "images/cer_5.png";
	            	}
	            	if(data['body']['authentication']['merchants']==1){
	            		var merchants_img = "images/cer-icon-7.png";
	            	}else{
	            		var merchants_img = "images/cer_6.png";
	            	}
	            	if(data['body']['authentication']['skill']==1){
	            		var skill_img = "images/cer-icon-8.png";
	            	}else{
	            		var skill_img = "images/cer_7.png";
	            	}
	            	switch(parseInt(data['body']['status'])){
	            		case 1: 
	            			var status = '<cite class="my-order-sate my-order-icona ovw" style="background: #fff url(\"../images/ing_6.jpg\") no-repeat scroll 0.4rem center / auto 0.4666rem;>待接单</cite>';
	            			var order_status = '<a class="over-order ovw" href="">我要接单</a>';
	            			$('.my-import-ula').addClass('note');
	            			msgList(msgList_params);//加载留言
	            			break;
	            		case 2: 
	            			var status = '<cite class="my-order-sate my-order-icona ovw" style="background: #fff url(\"../images/ing_8.jpg\") no-repeat scroll 0.4rem center / auto 0.4666rem;">进行中</cite>';
	            			var order_status = '<a class="over-order ovw" href="">我要接单</a>';
	            			msgList(msgList_params);//加载留言
	            			break;
	            		case 3: 
	            			var status = '<cite class="my-order-sate my-order-icona ovw">等待确认</cite>';
	            			var order_status = '<article class="my-order-content-b ovw"><dl class="my-order-content-dla ovw"><dt><img src="'+data['body']['buyers']['userAvatar']+'" class="order-tx" /><div class="fl"><p class="my-order-name ovw"><font class="fl ovw">'+data['body']['buyers']['username']+'</font><img src="images/ing_5.png" class="fl"/>'+phone_replace(data['body']['buyers']['phone'])+'</p><span class="my-order-name ovw"></span></div></dt></dl><p class="my-order-content-pc ovw">您已接单请等待农户选择</p></article><a class="over-order ovw cancel-order" href="">取消订单</a><ul class="my-order-select ovw"><li class="fl"><a href="#">发送短信</a></li><li class="fr"><a href="#">拨打电话</a></li></ul>';
	            			break;
	            		case 4: 
	            			var status = '<cite class="my-order-sate my-order-icona ovw" style="background: #fff url(\"../images/ing_7.jpg\") no-repeat scroll 0.4rem center / auto 0.4666rem;">已完成</cite>';
	            			var order_status = '<article class="my-order-content-b ovw"><dl class="my-order-content-dla ovw"><dt><img src="'+data['body']['buyers']['userAvatar']+'" class="order-tx" /><div class="fl"><p class="my-order-name ovw"><font class="fl ovw">'+data['body']['buyers']['username']+'</font><img src="images/ing_5.png" class="fl"/></p><span class="my-order-name ovw">'+phone_replace(data['body']['buyers']['phone'])+'</span></div></dt><dd><a href=""><img src="images/ing_3.png"/></a></dd></dl><p class="my-order-content-pc ovw">您已接单请等待农户选择</p></article>';
	            			break;
	            		case 5: 	
	            			var status = '';
	            			break;
	            	}
	            	var farmWorkDetailHtml = status+'<article class="my-order-content-a ovw"><dl class="my-order-content-dla ovw"><dt><img src="'+data['body']['userAvatar']+'" class="order-tx" /><div class="fl"><p class="my-order-name ovw"><font class="fl ovw">'+data['body']['username']+'</font><img src="images/ing_2.png" class="fl"/></p><span class="my-order-name ovw">'+phone_replace(data['body']['phone'])+'</span></div></dt><dd><a href=""><img src="images/ing_3.png"/></a></dd></dl><ul class="my-order-dete ovw"><li><label class="my-order-dete-time ovw fl">认证信息:</label><span class="fl ovw"><img src="'+phone_img+'" class="cer-icon-a" /><img src="'+realname_img+'" class="cer-icon-b" /><img src="'+land_img+'" class="cer-icon-c" /><img src="'+contractor_img+'" class="cer-icon-d" /><img src="'+machine_img+'" class="cer-icon-e" /><img src="'+merchants_img+'" class="cer-icon-f" /><img src="'+skill_img+'" class="cer-icon-g" /></span></li><li><label class="my-order-dete-time ovw fl">作业时间:</label><p class="my-order-dete-pb ovw fl">'+toLocalTime(data['body']['timeline'],1)+'</p></li><li><label class="my-order-dete-time ovw fl">作业地点:</label><p class="my-order-dete-pb my-order-dete-pc ovw fl">'+data['body']['address']+'</p></li><li><label class="my-order-dete-time ovw fl">作业面积:</label><p class="my-order-dete-pb ovw fl">'+data['body']['acreage']+'</p></li><li><label class="my-order-dete-time ovw fl">作业内容:</label><p class="my-order-dete-pb ovw fl">'+data['body']['machineName']+'</p></li><li><label class="my-order-dete-time ovw fl">理想报价:</label><p class="my-order-dete-pb ovw fl">'+data['body']['price']+'</p></li><li><label class="my-order-dete-time ovw fl">详细说明:</label><p class="my-order-dete-pb ovw fl">'+data['body']['intro']+'</p></li></ul></article>';

			    	$('.header').after(farmWorkDetailHtml+order_status);
			    	
	            }else{
	            	html = '<div class="none-more-content">暂无内容</div>';
                    $('.header').after(html);
	            }
	        },
	        error: function(XMLHttpRequest, textStatus, errorThrown) {
	            layer.msg('网络请求延迟！');
	            console.info(XMLHttpRequest.status);
	            console.info(XMLHttpRequest.readyState);
	            console.info(textStatus);
	        },
	    });
	}
	var params = {
		// 'userid':1,
		'framworkID':farmWorkID,
	}
	farmWorkDetail(params);

	//*********************************通用留言列表接口***********************************
	var count = 0;
	var msgList_params = {
		'infoID':farmWorkID,//农活ID
		'infoType':1,//1.农活2.零活3.求职
		'page':PAGE,
		'num':PAGE_NUM,
	};
	function msgList(params){
		var cmd = 'msgList';//通用留言列表接口命令
	    var ts = parseInt(new Date().getTime()/1000);//当前时间戳
	    var jsonp = 1;
	    params = objKeySort(params);//按照属性名升序排列
	    var params_str = objChangeStr(params);//拼接params参数的属性值
	    params.verify = $.md5(cmd+ts+params_str+'security');//生成验证码           
	    $.ajax({
	        url : apiURL,//接口地址
	         data : {'cmd':cmd, 'ts':ts, 'params':params, 'jsonp':jsonp},
	        dataType : 'jsonp',
	        success: function(data){
	        	if(isNull(data['body']['list'])){
	        		var noteListHtml = '';
	        		$.each(data['body']['list'],function(i,val){
	        			noteListHtml += '<dl class="my-order-discuss ovw"><dt><img src="'+val['userAvatar']+'"/></dt><dd><span class="my-or-spa ovw">'+val['username']+'</span><p class="my-or-pa ovw">'+val['content']+'</p><samp class="my-or-sap ovw">'+toLocalTime(val['commentTime'],6)+'</samp></dd></dl>';
	        			count++;
	        		})
	        		// $('.my-dis-cont').append(noteListHtml);

	        		setTimeout(function(){
                    	if(count<((params.page)*params.num)){
                    		$('.my-dis-cont').before(noteListHtml);
                            dropload.lock();// 锁定
                            dropload.noData();// 无数据
                            dropload.resetload();// 每次数据加载完，必须重置
                        }
                	},500);
	        	}else{
	        		if(count!=0){
	        			dropload.lock();// 锁定
                        dropload.noData();// 无数据
                        dropload.resetload();// 每次数据加载完，必须重置
	        		}
	        	}
	        },
	        error: function(XMLHttpRequest, textStatus, errorThrown) {
	            layer.msg('网络请求延迟！');
	            console.info(XMLHttpRequest.status);
	            console.info(XMLHttpRequest.readyState);
	            console.info(textStatus);
	        },
	    });
	}
	//*********************************留言列表上拉加载*****************
	function dropload_msgList(params){
		dropload = $('.my-dis-cont').dropload({
		    scrollArea : window,
		    domUp : {
		        domClass   : 'dropload-up',
		        domRefresh : '<div class="dropload-refresh">↓下拉刷新</div>',
		        domUpdate  : '<div class="dropload-update">↑释放更新</div>',
		        domLoad    : '<div class="dropload-load"><span class="loading"></span>加载中...</div>'
		    },
		    domDown : {
		        domClass   : 'dropload-down',
		        domRefresh : '<div class="dropload-refresh"></div>',
		        domLoad    : '<div class="dropload-load"><span class="loading"></span>加载中...</div>',
		        domNoData  : '<div class="dropload-noData">加载完成</div>'
		    },
		    loadUpFn : function(me){
		    	//下拉刷新
		    	params.page=0;
		    	msgList(params);
		    	params.page = 1;
		    },
		    loadDownFn : function(me){
		    	//上拉加载
		    	msgList(params);
		        params.page++;
		    },
		    threshold : 50
		});
	}

	//*********************************通用留言接口***********************************
	$('.note').on('click',function(){
		var note_content = $.trim($('.import-a').val());
		if(!isNull(note_content)){
			layer.msg('留言内容不能为空');
			return false;
		}else{
			var msgRelease_params = {
				'userid':1,
				'infoID':farmWorkID,//农活ID
				'infoType':1,//1.农活2.零活3.求职
				'content':note_content,
			};
			msgRelease(msgRelease_params);
		}
	})
	
	function msgRelease(params){
		var cmd = 'msgRelease';//通用留言接口命令
	    var ts = parseInt(new Date().getTime()/1000);//当前时间戳
	    var jsonp = 1;
	    params = objKeySort(params);//按照属性名升序排列
	    var params_str = objChangeStr(params);//拼接params参数的属性值
	    params.verify = $.md5(cmd+ts+params_str+'security');//生成验证码           
	    $.ajax({
	        url : apiURL,//接口地址
	         data : {'cmd':cmd, 'ts':ts, 'params':params, 'jsonp':jsonp},
	        dataType : 'jsonp',
	        success: function(data){
	        	if(data['resultCode']==1){
	        		layer.msg("留言成功!");
	        	}else{
	        		layer.msg("留言失败，系统出错!");
	        	}
	        },
	        error: function(XMLHttpRequest, textStatus, errorThrown) {
	            layer.msg('网络请求延迟！');
	            console.info(XMLHttpRequest.status);
	            console.info(XMLHttpRequest.readyState);
	            console.info(textStatus);
	        },
	    });
	}

	//**********************************农活关注***************************
	$('.farm-work-mark').on('click touched',function(){
		var macMark_params = {
			'userid':1,
			'id':farmWorkID,
			'type':2,//1农机；2农活；3零活；4商品；5圈子；6零工；7二手
		};
		mark(macMark_params);
	})
})
</script>
</body>
</html>